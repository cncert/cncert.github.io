let treeData = [];
let flatFiles = [];
let currentActive = null;

// åŠ è½½ç›®å½•æ ‘
fetch('files.json')
  .then(res => res.json())
  .then(json => {
    treeData = json;
    flatFiles = getAllFiles(treeData);
    renderTree(treeData, document.getElementById('tree'));
  });

function getAllFiles(tree, prefix = '') {
  let files = [];
  tree.forEach(item => {
    if (item.type === 'file') {
      files.push({...item, fullpath: (prefix ? prefix + '/' : '') + item.name});
    } else if (item.type === 'folder') {
      files = files.concat(getAllFiles(item.children || [], (prefix ? prefix + '/' : '') + item.name));
    }
  });
  return files;
}

// æ¸²æŸ“ç›®å½•æ ‘
function renderTree(tree, container, path = '') {
  container.innerHTML = '';
  tree.forEach(item => {
    const div = document.createElement('div');
    div.className = 'tree-node ' + (item.type === 'folder' ? 'tree-folder' : 'tree-file');
    div.textContent = (item.type === 'folder' ? 'ðŸ“‚ ' : 'ðŸ“„ ') + item.name;
    div.setAttribute('data-path', (path ? path + '/' : '') + item.name);
    if (item.type === 'file') {
      div.onclick = () => selectFile(item, div);
    }
    if (item.type === 'folder') {
      // å¯æŠ˜å 
      const toggle = document.createElement('span');
      toggle.className = 'tree-toggle';
      toggle.textContent = 'â–¶';
      let expanded = false;
      let childrenDiv = document.createElement('div');
      childrenDiv.className = 'tree-children';
      childrenDiv.style.display = 'none';
      toggle.onclick = (e) => {
        e.stopPropagation();
        expanded = !expanded;
        childrenDiv.style.display = expanded ? '' : 'none';
        toggle.textContent = expanded ? 'â–¼' : 'â–¶';
      };
      div.prepend(toggle);
      div.onclick = (e) => {
        if (e.target !== toggle) {
          expanded = !expanded;
          childrenDiv.style.display = expanded ? '' : 'none';
          toggle.textContent = expanded ? 'â–¼' : 'â–¶';
        }
      };
      container.appendChild(div);
      renderTree(item.children, childrenDiv, (path ? path + '/' : '') + item.name);
      container.appendChild(childrenDiv);
    } else {
      container.appendChild(div);
    }
  });
}

// æ–‡ä»¶ç‚¹å‡»å±•ç¤º
function selectFile(file, nodeDiv) {
  if (currentActive) currentActive.classList.remove('active');
  nodeDiv.classList.add('active');
  currentActive = nodeDiv;
  document.getElementById('file-title').textContent = file.name;
  const ext = file.name.split('.').pop().toLowerCase();
  const fileUrl = encodeURI(file.path);
  if (['png','jpg','jpeg','gif','bmp','svg','webp'].includes(ext)) {
    document.getElementById('file-content').innerHTML =
      `<img src="${fileUrl}" alt="${file.name}" /><div style="margin:0.7em 0"><a href="${fileUrl}" download>ä¸‹è½½å›¾ç‰‡</a></div>`;
  } else if (['md','txt','json','js','css','html','py','java','c','cpp','xml','sh','ts','yml','yaml'].includes(ext)) {
    // çº¯æ–‡æœ¬é¢„è§ˆ
    fetch(fileUrl).then(r=>r.text()).then(text=>{
      document.getElementById('file-content').innerHTML = `<pre>${escapeHtml(text.slice(0,20000))}${text.length>20000?'\n...(å†…å®¹è¿‡é•¿æˆªæ–­)':''}</pre>
      <div style="margin:0.7em 0"><a href="${fileUrl}" download>ä¸‹è½½æ–‡ä»¶</a></div>`;
    }).catch(()=>document.getElementById('file-content').innerHTML = 'æ— æ³•é¢„è§ˆæ–‡ä»¶ã€‚');
  } else {
    document.getElementById('file-content').innerHTML =
      `<a href="${fileUrl}" download>ä¸‹è½½è¯¥æ–‡ä»¶</a>`;
  }
}

// æœç´¢
document.getElementById('globalSearch').addEventListener('input', function() {
  const key = this.value.trim().toLowerCase();
  if (!key) {
    renderTree(treeData, document.getElementById('tree'));
    return;
  }
  // æœç´¢æ‰€æœ‰æ–‡ä»¶ã€æ–‡ä»¶å¤¹
  let matchedFiles = flatFiles.filter(f => f.name.toLowerCase().includes(key) || (f.fullpath||'').toLowerCase().includes(key));
  let html = matchedFiles.length ? matchedFiles.map(f =>
    `<div class="tree-node tree-file" data-path="${f.fullpath}" style="margin-left:0.5em;cursor:pointer;" onclick="selectFileByPath('${f.fullpath.replace(/'/g,"\\'")}')">
      ðŸ“„ ${f.fullpath}
    </div>`).join('') : '<div style="color:#e85959;font-size:1.05em;margin:1em">æœªæ‰¾åˆ°ç›¸å…³æ–‡ä»¶</div>';
  document.getElementById('tree').innerHTML = html;
});

// è¾…åŠ©ï¼šæ ¹æ® fullpath é€‰æ‹©æ–‡ä»¶
window.selectFileByPath = function(fullpath) {
  let file = flatFiles.find(f => f.fullpath === fullpath);
  if (file) selectFile(file, document.querySelector(`[data-path="${CSS.escape(fullpath)}"]`));
};

function escapeHtml(text) {
  return text.replace(/[<>&"]/g, c => ({
    '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'
  }[c]));
}